name: Sync Commit with Trello

on:
  push:
    branches:
      - main
      - master
      - develop

jobs:
  update-trello:
    runs-on: ubuntu-latest

    steps:
      - name: Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù¾ÛŒØ§Ù… Ú©Ø§Ù…ÛŒØª Ùˆ Ù„ÛŒÙ†Ú© Trello (Ø§ÛŒÙ…Ù† Ø¨Ø±Ø§ÛŒ multiline)
        id: extract
        shell: bash
        run: |
          # Ø§Ú¯Ø± head_commit Ø®Ø§Ù„ÛŒ Ø¨ÙˆØ¯ (Ù…Ø«Ù„Ø§Ù‹ Ø¯Ø± Ø¨Ø¹Ø¶ÛŒ eventÙ‡Ø§) Ø§Ù…Ù†â€ŒØ³Ø§Ø²ÛŒ Ú©Ù†
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          if [ -z "$COMMIT_MSG" ]; then
            COMMIT_MSG="${{ github.event.before }} (no commit message found)"
          fi

          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§ÙˆÙ„ÛŒÙ† Ù„ÛŒÙ†Ú© Trello Ø§Ø² Ù…ØªÙ† (Ø¯Ø± ØµÙˆØ±Øª ÙˆØ¬ÙˆØ¯)
          TRELLO_URL=$(printf '%s\n' "$COMMIT_MSG" | grep -Eo 'https://trello.com/c/[A-Za-z0-9]+' | head -n1 || true)

          # Ù†ÙˆØ´ØªÙ† multiline Ø¨Ù‡ ØµÙˆØ±Øª Ø§Ù…Ù† Ø¨Ù‡ GITHUB_OUTPUT
          # Ø¨Ø±Ø§ÛŒ msg Ø§Ø² ÙØ±Ù…Øª <<EOF Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… ØªØ§ Ù…ØªÙ† Ú†Ù†Ø¯Ø®Ø·ÛŒ Ù…Ø´Ú©Ù„ÛŒ Ù†Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯
          printf "msg<<EOF\n%s\nEOF\n" "$COMMIT_MSG" >> "$GITHUB_OUTPUT"

          # Ø¨Ø±Ø§ÛŒ url Ù‡Ù… Ø§Ø² ÙØ±Ù…Øª <<EOF Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… (Ø¨ÛŒâ€ŒØ®Ø·Ø± Ø­ØªÛŒ Ø§Ú¯Ø± Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯)
          printf "url<<EOF\n%s\nEOF\n" "$TRELLO_URL" >> "$GITHUB_OUTPUT"

      - name: Ù†Ù…Ø§ÛŒØ´ Ù…Ù‚Ø§Ø¯ÛŒØ± Ø§Ø³ØªØ®Ø±Ø§Ø¬â€ŒØ´Ø¯Ù‡ (Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¨Ø§Ú¯)
        run: |
          echo "---- commit message ----"
          echo "${{ steps.extract.outputs.msg }}"
          echo "---- trello url ----"
          echo "${{ steps.extract.outputs.url }}"

      - name: ØªÙˆÙ‚Ù Ø§Ú¯Ø± Ù„ÛŒÙ†Ú© Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯
        if: steps.extract.outputs.url == ''
        run: |
          echo "Ù‡ÛŒÚ† Ù„ÛŒÙ†Ú© Ú©Ø§Ø±Øª Trello Ø¯Ø± Ù¾ÛŒØ§Ù… Ú©Ø§Ù…ÛŒØª Ù†ÛŒØ³Øª â€” Ø§Ú©Ø´Ù† Ù…ØªÙˆÙ‚Ù Ø´Ø¯."
          
      - name: Ø§Ø³ØªØ®Ø±Ø§Ø¬ CARD ID
        id: id
        if: steps.extract.outputs.url != ''
        run: |
          # ØªØ¨Ø¯ÛŒÙ„ https://trello.com/c/AbC12345 Ø¨Ù‡ AbC12345
          CARD_ID=$(echo "${{ steps.extract.outputs.url }}" | sed -e 's#https://trello.com/c/##' -e 's#/$##')
          printf "card=%s\n" "$CARD_ID" >> "$GITHUB_OUTPUT"

      - name: Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú©Ø§Ù…Ù†Øª Ø±ÙˆÛŒ Ú©Ø§Ø±Øª Trello
        if: steps.extract.outputs.url != ''
        run: |
          CARD="${{ steps.id.outputs.card }}"
          COMMENT="ğŸ’¬ Commit Message:\n\n${{ steps.extract.outputs.msg }}"

          curl -s -X POST "https://api.trello.com/1/cards/$CARD/actions/comments" \
            -d "text=$COMMENT" \
            -d "key=${{ secrets.TRELLO_KEY }}" \
            -d "token=${{ secrets.TRELLO_TOKEN }}" \
            || (echo "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú©Ø§Ù…Ù†Øª Ø¨Ù‡ Trello" && exit 1)

      - name: Ø§ØªÚ† Ú©Ø±Ø¯Ù† Ù„ÛŒÙ†Ú© Ú©Ø§Ù…ÛŒØª Ø¨Ù‡ Ú©Ø§Ø±Øª (Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒâ€ŒØ´Ø¯Ù‡)
        if: steps.extract.outputs.url != ''
        run: |
          CARD="${{ steps.id.outputs.card }}"
          # Ù„ÛŒÙ†Ú© Ú©Ø§Ù…ÛŒØª Ú¯ÛŒØªâ€ŒÙ‡Ø§Ø¨ (API url ÛŒØ§ web url) â€” github.event.head_commit.url Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ API url Ø§Ø³Øª
          COMMIT_URL="${{ github.event.head_commit.url }}"

          # Ø§Ú¯Ø± Ø®ÙˆØ§Ø³ØªÛŒ Ù„ÛŒÙ†Ú© ÙˆØ¨ Ø±Ø§ ØªØ±Ø¬ÛŒØ­ Ø¨Ø¯ÛŒ Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø§ÛŒÙ† Ø±Ø§ Ø¨Ø³Ø§Ø²ÛŒ:
          # COMMIT_WEB="https://github.com/${{ github.repository }}/commit/${{ github.event.head_commit.id }}"

          curl -s -X POST "https://api.trello.com/1/cards/$CARD/attachments" \
            -d "url=$COMMIT_URL" \
            -d "name=Commit: $COMMIT_URL" \
            -d "key=${{ secrets.TRELLO_KEY }}" \
            -d "token=${{ secrets.TRELLO_TOKEN }}" \
            || (echo "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† attachment Ø¨Ù‡ Trello" && exit 1)
